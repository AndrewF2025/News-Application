

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News_app.views &mdash; Django News Application 00.00.01 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d7bb8d4d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Django News Application
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation &amp; Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models_explanation.html">Database Models Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">Database Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_serializers_explanation.html">API Serializers Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_serializers.html">API Serializers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests_api_explanation.html">API Tests Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests_api.html">API Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../urls_explanation.html">URL Routing Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">REST API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../forms_explanation.html">Forms Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../forms.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views_explanation.html">Views Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views.html">Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin_explanation.html">Admin Interface Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin.html">Admin</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Django News Application</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">News_app.views</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for News_app.views</h1><div class="highlight"><pre>
<span></span><span class="c1"># News_app/views.py</span>
<span class="c1"># --------- Imports ---------</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_POST</span><span class="p">,</span> <span class="n">require_GET</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.tokens</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_token_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlsafe_base64_encode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.encoding</span><span class="w"> </span><span class="kn">import</span> <span class="n">force_bytes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">viewsets</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">api_view</span><span class="p">,</span> <span class="n">permission_classes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsAuthenticated</span><span class="p">,</span> <span class="n">AllowAny</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_model</span><span class="p">,</span> <span class="n">login</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">user_passes_test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.paginator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseForbidden</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Article</span><span class="p">,</span> <span class="n">Newsletter</span><span class="p">,</span> <span class="n">Publisher</span><span class="p">,</span> <span class="n">Category</span><span class="p">,</span> <span class="n">Comment</span><span class="p">,</span>
    <span class="n">Subscription</span><span class="p">,</span> <span class="n">PublisherStaff</span><span class="p">,</span> <span class="n">CustomUser</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.serializers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">UserSerializer</span><span class="p">,</span>
    <span class="n">UserCreateSerializer</span><span class="p">,</span>
    <span class="n">CategorySerializer</span><span class="p">,</span>
    <span class="n">PublisherSerializer</span><span class="p">,</span>
    <span class="n">ArticleSerializer</span><span class="p">,</span>
    <span class="n">ArticleCreateSerializer</span><span class="p">,</span>
    <span class="n">NewsletterSerializer</span><span class="p">,</span>
    <span class="n">CommentSerializer</span><span class="p">,</span>
    <span class="n">ArticleApprovalSerializer</span><span class="p">,</span>
    <span class="n">NewsletterApprovalSerializer</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CustomUserCreationForm</span><span class="p">,</span>
    <span class="n">ArticleForm</span><span class="p">,</span>
    <span class="n">PublisherForm</span><span class="p">,</span>
    <span class="n">CategoryForm</span><span class="p">,</span>
    <span class="n">CommentForm</span><span class="p">,</span>
    <span class="n">NewsletterForm</span><span class="p">,</span>
    <span class="n">CustomUserChangeForm</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.functions.twitter_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">twitter_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.mail</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_mail</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.password_validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_password</span>


<span class="c1"># --------- Helper Functions ---------</span>
<span class="n">User</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>


<span class="c1"># ----- Decorators -----</span>
<span class="c1"># Decorator to redirect superusers to admin home</span>
<div class="viewcode-block" id="superuser_redirect">
<a class="viewcode-back" href="../../views.html#News_app.views.superuser_redirect">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">superuser_redirect</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirect superusers to the admin home page for template views.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># If user is authenticated and is a superuser</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
            <span class="c1"># Redirect to admin_home</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
        <span class="c1"># Else, proceed with the view</span>
        <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_wrapped_view</span></div>



<span class="c1"># Role Required Decorator</span>
<div class="viewcode-block" id="role_required">
<a class="viewcode-back" href="../../views.html#News_app.views.role_required">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">role_required</span><span class="p">(</span><span class="n">role</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restrict access to users with a specific role.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Inner wrapper to enforce role-based access.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># If user is a superuser</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
                <span class="c1"># Redirect to admin_home</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
            <span class="c1"># If user is not authenticated or doesn&#39;t have the required role</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="n">role</span><span class="p">:</span>
                <span class="c1"># Deny access</span>
                <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">s can access this page.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Else, proceed with the view</span>
            <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_wrapped_view</span>
    <span class="k">return</span> <span class="n">decorator</span></div>



<span class="c1"># Editor Required Decorator</span>
<div class="viewcode-block" id="editor_required">
<a class="viewcode-back" href="../../views.html#News_app.views.editor_required">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">editor_required</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restrict access to users who can manage content (editors).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">view_func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_wrapped_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inner wrapper to enforce editor access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If user is not authenticated or cannot manage content</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_manage_content</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="c1"># Deny access</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Only editors can access this page.&quot;</span><span class="p">)</span>
        <span class="c1"># Else, allow the user to proceed to the original view</span>
        <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_wrapped_view</span></div>



<span class="c1"># ----- Subscription Helpers -----</span>
<span class="c1"># Helper functions for subscriptions</span>
<div class="viewcode-block" id="get_subscribed_publishers">
<a class="viewcode-back" href="../../views.html#News_app.views.get_subscribed_publishers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_subscribed_publishers</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a QuerySet of publishers the user is subscribed to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return publishers the user is subscribed to</span>
    <span class="k">return</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">id__in</span><span class="o">=</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">publisher__isnull</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span></div>



<span class="c1"># Helper function to get subscribed journalists</span>
<div class="viewcode-block" id="get_subscribed_journalists">
<a class="viewcode-back" href="../../views.html#News_app.views.get_subscribed_journalists">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_subscribed_journalists</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a QuerySet of journalists the user is subscribed to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return journalists the user is subscribed to</span>
    <span class="k">return</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">id__in</span><span class="o">=</span><span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">journalist__isnull</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;journalist_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span></div>



<span class="c1"># Helper function for admin check</span>
<div class="viewcode-block" id="is_admin">
<a class="viewcode-back" href="../../views.html#News_app.views.is_admin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_admin</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if the user is authenticated and is a superuser (admin).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return True if user is authenticated and is a superuser</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span></div>



<span class="c1"># ----- Shared Content Helpers -----</span>
<span class="c1"># Shared function to paginate queryset</span>
<div class="viewcode-block" id="paginate_queryset">
<a class="viewcode-back" href="../../views.html#News_app.views.paginate_queryset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">paginate_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">page_param</span><span class="o">=</span><span class="s1">&#39;page&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Paginate a queryset for the given request and return the page object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create paginator for the queryset</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">per_page</span><span class="p">)</span>
    <span class="n">page_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">page_param</span><span class="p">)</span>
    <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>
    <span class="c1"># Return the paginated page object</span>
    <span class="k">return</span> <span class="n">page_obj</span></div>



<span class="c1"># Shared function to get display role for user</span>
<div class="viewcode-block" id="get_display_role">
<a class="viewcode-back" href="../../views.html#News_app.views.get_display_role">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_display_role</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the display role string for a user (Admin or role display).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is a superuser</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Return &#39;Admin&#39; as role</span>
        <span class="k">return</span> <span class="s1">&#39;Admin&#39;</span>
    <span class="c1"># If not, return their role display</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">get_role_display</span><span class="p">()</span></div>



<span class="c1"># Shared Publish Content Helper</span>
<div class="viewcode-block" id="publish_content">
<a class="viewcode-back" href="../../views.html#News_app.views.publish_content">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_content</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="n">staff_check</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Publish articles or newsletters, with permission checks and</span>
<span class="sd">    notifications.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is a superuser</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin_home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="c1"># If user cannot manage content</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">can_manage_content</span><span class="p">():</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only editors can publish </span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2">s.&quot;</span><span class="p">)</span>
    <span class="c1"># If object is independent</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;is_independent&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_independent</span><span class="p">:</span>
        <span class="c1"># Any editor can publish independent articles/newsletters</span>
        <span class="c1"># If object is not approved</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_approved</span><span class="p">:</span>
            <span class="c1"># Show error and redirect</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> must be approved before publishing.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Redirect to pending approvals</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pending_approvals&#39;</span><span class="p">)</span>
        <span class="c1"># Else, publish the object</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">published_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Notify subscribers (email and Twitter)</span>
        <span class="n">notify_subscribers</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Independent </span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2"> published successfully!&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Redirect to pending approvals</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pending_approvals&#39;</span><span class="p">)</span>
    <span class="c1"># Else, object is not independent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Only editors who are staff of the publisher can publish</span>
        <span class="c1"># If staff_check is provided</span>
        <span class="k">if</span> <span class="n">staff_check</span><span class="p">:</span>
            <span class="c1"># If user is not staff for this publisher</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">staff_check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                <span class="c1"># Deny access</span>
                <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
                    <span class="s2">&quot;You are not staff for this publisher.&quot;</span>
                <span class="p">)</span>
        <span class="c1"># If object is not approved</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_approved</span><span class="p">:</span>
            <span class="c1"># Show error and redirect</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> must be approved before publishing.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Redirect to pending approvals</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pending_approvals&#39;</span><span class="p">)</span>
        <span class="c1"># Else, publish the object</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">published_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Notify subscribers (email and Twitter)</span>
        <span class="n">notify_subscribers</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> published successfully!&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Redirect to pending approvals</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pending_approvals&#39;</span><span class="p">)</span></div>



<span class="c1"># Helper to notify subscribers via email and Twitter</span>
<div class="viewcode-block" id="notify_subscribers">
<a class="viewcode-back" href="../../views.html#News_app.views.notify_subscribers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">notify_subscribers</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notify subscribers via email and Twitter when an article or</span>
<span class="sd">    newsletter is published.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all subscriptions to the author or publisher</span>
    <span class="n">emails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># If the object is an article</span>
    <span class="k">if</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s1">&#39;article&#39;</span><span class="p">:</span>
        <span class="c1"># Get subscriptions for the journalist (author)</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">journalist</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
        <span class="c1"># If the article has a publisher</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
            <span class="c1"># Include subscriptions for the publisher</span>
            <span class="n">subs</span> <span class="o">|=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span>
    <span class="c1"># Else, if the object is a newsletter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get subscriptions for the journalist (author)</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">journalist</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
        <span class="c1"># If the newsletter has a publisher</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
            <span class="c1"># Include subscriptions for the publisher</span>
            <span class="n">subs</span> <span class="o">|=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span>
    <span class="c1"># Collect unique emails from subscriptions</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
        <span class="n">emails</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">subscriber</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
    <span class="c1"># If there are any emails to notify</span>
    <span class="k">if</span> <span class="n">emails</span><span class="p">:</span>
        <span class="c1"># Send email notification</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;New </span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Published: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;A new </span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2"> has been published by &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Read it now on News Application!&quot;</span>
        <span class="p">)</span>
        <span class="n">send_mail</span><span class="p">(</span>
            <span class="n">subject</span><span class="p">,</span>
            <span class="n">message</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_FROM_EMAIL</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">emails</span><span class="p">),</span>
            <span class="n">fail_silently</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="c1"># Post to Twitter using TwitterService</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># If the object is an article</span>
        <span class="k">if</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s1">&#39;article&#39;</span><span class="p">:</span>
            <span class="c1"># Post a new article tweet</span>
            <span class="n">twitter_service</span><span class="o">.</span><span class="n">tweet_new_article</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">author_name</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span>
            <span class="p">)</span>
        <span class="c1"># Else, if the object is a newsletter</span>
        <span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span>
            <span class="c1"># Post a new newsletter tweet</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">twitter_service</span><span class="o">.</span><span class="n">tweet_new_newsletter</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">author_name</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">image_path</span><span class="o">=</span><span class="n">image_path</span>
            <span class="p">)</span>
    <span class="c1"># Handle any Twitter posting errors</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Twitter notification error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># Shared Staff Check Helper</span>
<div class="viewcode-block" id="staff_editor_check">
<a class="viewcode-back" href="../../views.html#News_app.views.staff_editor_check">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">staff_editor_check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if the user is an editor staff member for the object&#39;s</span>
<span class="sd">    publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not authenticated or does not have a publisher</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
        <span class="c1"># Return False</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Get all staff IDs for the user with editor role</span>
    <span class="n">staff_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="c1"># Return True if the user&#39;s publisher ID is in the staff IDs</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">staff_ids</span></div>



<span class="c1"># Shared Approval Helper</span>
<div class="viewcode-block" id="approve_content">
<a class="viewcode-back" href="../../views.html#News_app.views.approve_content">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">approve_content</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Approve articles or newsletters (shared logic).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If object type is article and user cannot approve articles</span>
    <span class="k">if</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s1">&#39;article&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Only editors can approve articles.&quot;</span><span class="p">)</span>
    <span class="c1"># If object type is newsletter and user cannot manage content</span>
    <span class="k">if</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s1">&#39;newsletter&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_manage_content</span><span class="p">():</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Only editors can approve newsletters.&quot;</span><span class="p">)</span>
    <span class="c1"># Get the object to approve</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">is_approved</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">approved_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">approval_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1"># If the object is approved send notifications</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s1">&quot; has been approved!&#39;</span>
    <span class="p">)</span>
    <span class="c1"># Redirect to pending approvals</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pending_approvals&#39;</span><span class="p">)</span></div>



<span class="c1"># Shared Deletion Helper</span>
<div class="viewcode-block" id="delete_content">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_content">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_content</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="n">redirect_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete articles or newsletters (shared logic).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">)</span>
    <span class="c1"># Allow deletion by editors or the journalist who created the object</span>
    <span class="c1"># If user is not the author and not an editor</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="n">author</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;editor&#39;</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Only the author (journalist) or editors can delete </span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s2">s.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Else, delete the object</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> deleted successfully!&quot;</span><span class="p">)</span>
    <span class="c1"># Then redirect to the specified URL</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span></div>



<span class="c1"># ----- Shared Comment Permission Helper -----</span>
<div class="viewcode-block" id="can_manage_comment">
<a class="viewcode-back" href="../../views.html#News_app.views.can_manage_comment">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">can_manage_comment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if the user can manage (edit/delete) the comment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is the author of the comment</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="n">comment</span><span class="o">.</span><span class="n">author</span><span class="p">:</span>
        <span class="c1"># Allow management</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># If user can manage content</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">can_manage_content</span><span class="p">():</span>
        <span class="c1"># Allow management</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># Else, deny management</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<span class="c1"># --------- Subscription Views ---------</span>
<span class="c1"># Subscriptions management view for readers</span>
<div class="viewcode-block" id="subscriptions_view">
<a class="viewcode-back" href="../../views.html#News_app.views.subscriptions_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;reader&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscriptions_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the user&#39;s current subscriptions to publishers and</span>
<span class="sd">    journalists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get current subscriptions</span>
    <span class="n">subscribed_publishers</span> <span class="o">=</span> <span class="n">get_subscribed_publishers</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">subscribed_journalists</span> <span class="o">=</span> <span class="n">get_subscribed_journalists</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Get all publishers and journalists</span>
    <span class="n">all_publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">all_journalists</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;subscribed_publishers&#39;</span><span class="p">:</span> <span class="n">subscribed_publishers</span><span class="p">,</span>
        <span class="s1">&#39;subscribed_journalists&#39;</span><span class="p">:</span> <span class="n">subscribed_journalists</span><span class="p">,</span>
        <span class="s1">&#39;all_publishers&#39;</span><span class="p">:</span> <span class="n">all_publishers</span><span class="p">,</span>
        <span class="s1">&#39;all_journalists&#39;</span><span class="p">:</span> <span class="n">all_journalists</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the subscriptions page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/subscriptions.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<span class="c1"># Subscribe/unsubscribe to publisher</span>
<div class="viewcode-block" id="unsubscribe_publisher_view">
<a class="viewcode-back" href="../../views.html#News_app.views.unsubscribe_publisher_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@require_POST</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;reader&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe_publisher_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unsubscribe the current user from a publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the publisher object</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="c1"># If the user is subscribed to this publisher</span>
    <span class="k">if</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># Delete the subscription</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
        <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c1"># Show success message</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Unsubscribed from publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">!&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Else, user was not subscribed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Show info message (alternative action)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;You were not subscribed to publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Redirect to subscriptions page</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span></div>



<span class="c1"># Subscribe/unsubscribe to journalist</span>
<div class="viewcode-block" id="subscribe_journalist_view">
<a class="viewcode-back" href="../../views.html#News_app.views.subscribe_journalist_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@require_POST</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;reader&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscribe_journalist_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">journalist_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe the current user to a journalist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the journalist object</span>
    <span class="n">journalist</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span>
        <span class="n">CustomUser</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span>
    <span class="p">)</span>
    <span class="c1"># If the user is not already subscribed to this journalist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># Create the subscription</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
        <span class="p">)</span>
        <span class="c1"># Show success message</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Subscribed to journalist &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1">!&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Else, user is already subscribed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Show info message (alternative action)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;You are already subscribed to journalist &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Redirect to subscriptions page</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="unsubscribe_journalist_view">
<a class="viewcode-back" href="../../views.html#News_app.views.unsubscribe_journalist_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@require_POST</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;reader&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe_journalist_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">journalist_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unsubscribe the current user from a journalist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the journalist object</span>
    <span class="n">journalist</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span>
        <span class="n">CustomUser</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span>
    <span class="p">)</span>
    <span class="c1"># If the user is subscribed to this journalist</span>
    <span class="k">if</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># Delete the subscription</span>
        <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
        <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c1"># Show success message</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Unsubscribed from journalist &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1">!&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Else, user was not subscribed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Show info message (alternative action)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;You were not subscribed to journalist &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Redirect to subscriptions page</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span></div>



<span class="c1"># --------- HTML Template Views ---------</span>

<div class="viewcode-block" id="home_view">
<a class="viewcode-back" href="../../views.html#News_app.views.home_view">[docs]</a>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">home_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the home page with latest articles, categories, and stats.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get latest published and approved articles</span>
    <span class="n">latest_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Get categories</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Get stats</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;total_articles&#39;</span><span class="p">:</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s1">&#39;total_newsletters&#39;</span><span class="p">:</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s1">&#39;total_categories&#39;</span><span class="p">:</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s1">&#39;total_publishers&#39;</span><span class="p">:</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># Render the home page with context</span>
    <span class="c1"># Pass latest articles, categories, and stats to the template</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;latest_articles&#39;</span><span class="p">:</span> <span class="n">latest_articles</span><span class="p">,</span>
        <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="n">categories</span><span class="p">,</span>
        <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Return the rendered home page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/home.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<span class="c1"># Admin home view for superusers</span>
<div class="viewcode-block" id="admin_home">
<a class="viewcode-back" href="../../views.html#News_app.views.admin_home">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the admin home page for superusers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the user is not a superuser</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to home page</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="c1"># Else, render the admin home page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/admin_home.html&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="articles_view">
<a class="viewcode-back" href="../../views.html#News_app.views.articles_view">[docs]</a>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">articles_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the articles list view with search and category filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get published and approved articles</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Filter by search query</span>
    <span class="n">search_query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">)</span>
    <span class="c1"># If search query is provided</span>
    <span class="k">if</span> <span class="n">search_query</span><span class="p">:</span>
        <span class="c1"># Filter articles by search query</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="n">search_query</span><span class="p">)</span> <span class="o">|</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">content__icontains</span><span class="o">=</span><span class="n">search_query</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Filter by category</span>
    <span class="n">category_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="c1"># If category filter is provided</span>
    <span class="k">if</span> <span class="n">category_id</span><span class="p">:</span>
        <span class="c1"># Filter articles by category</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category_id</span><span class="o">=</span><span class="n">category_id</span><span class="p">)</span>

    <span class="c1"># Order and select related fields</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">articles</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span>
        <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>

    <span class="c1"># Use shared pagination helper</span>
    <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginate_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">articles</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># If category_id is provided</span>
    <span class="k">if</span> <span class="n">category_id</span><span class="p">:</span>
        <span class="c1"># Set selected_category_id to string value</span>
        <span class="n">selected_category_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">category_id</span><span class="p">)</span>
    <span class="c1"># If category_id is not provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set selected_category_id to empty string</span>
        <span class="n">selected_category_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Add &#39;selected&#39; attribute for each category for template</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># For each category, set the &#39;selected&#39; attribute</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="c1"># Set selected to True if this category is selected</span>
        <span class="n">category</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">selected_category_id</span>

    <span class="c1"># Prepare context for template</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
        <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="n">categories</span><span class="p">,</span>
        <span class="s1">&#39;is_paginated&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="o">.</span><span class="n">has_other_pages</span><span class="p">(),</span>
        <span class="s1">&#39;page_obj&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
        <span class="s1">&#39;selected_category_id&#39;</span><span class="p">:</span> <span class="n">selected_category_id</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the articles page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/articles.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="article_detail_view">
<a class="viewcode-back" href="../../views.html#News_app.views.article_detail_view">[docs]</a>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">article_detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the detail view for a single article, including comments and</span>
<span class="sd">    related articles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the article object</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>

    <span class="c1"># Check if user can view this article</span>
    <span class="c1"># If article is not published or not approved</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">article</span><span class="o">.</span><span class="n">is_published</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">article</span><span class="o">.</span><span class="n">is_approved</span><span class="p">:</span>
        <span class="c1"># If user is not authenticated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="c1"># Deny access to unauthenticated users</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;This article is not available.&quot;</span><span class="p">)</span>
        <span class="c1"># If user is not the author and not an editor</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="ow">and</span>
            <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="c1"># Deny access to unauthorized users</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;This article is not available.&quot;</span><span class="p">)</span>

    <span class="c1"># Get comments</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">article</span><span class="o">=</span><span class="n">article</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span>
        <span class="s1">&#39;author&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>

    <span class="c1"># Get related articles (same category, excluding current)</span>
    <span class="n">related_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">category</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Get latest articles</span>
    <span class="n">latest_articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
        <span class="s1">&#39;-created_date&#39;</span>
    <span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Prepare context for template</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">,</span>
        <span class="s1">&#39;related_articles&#39;</span><span class="p">:</span> <span class="n">related_articles</span><span class="p">,</span>
        <span class="s1">&#39;latest_articles&#39;</span><span class="p">:</span> <span class="n">latest_articles</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the article detail page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/article_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_comment_view">
<a class="viewcode-back" href="../../views.html#News_app.views.add_comment_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_comment_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a user to add a comment to an article.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is a superuser</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect superusers to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>

    <span class="c1"># Get the article object</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>

    <span class="c1"># If the request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Bind form with POST data</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># Create comment but don&#39;t save yet</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Set article and author</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">article</span> <span class="o">=</span> <span class="n">article</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="c1"># Save the comment</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Show success message</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Comment added successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to article detail</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;article_detail&#39;</span><span class="p">,</span> <span class="n">article_id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
        <span class="c1"># If form is not valid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Show error message</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Comment content is required.&#39;</span><span class="p">)</span>
    <span class="c1"># If the request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create a blank form</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="c1"># Render the add comment page with form and article</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/add_comment.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="newsletters_view">
<a class="viewcode-back" href="../../views.html#News_app.views.newsletters_view">[docs]</a>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">newsletters_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the newsletters list view, including independent newsletters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all published and approved newsletters</span>
    <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>

    <span class="c1"># Get independent newsletters for template logic</span>
    <span class="n">independent_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_independent</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Use shared pagination helper</span>
    <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginate_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletters</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Prepare context for template</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
        <span class="s1">&#39;independent_newsletters&#39;</span><span class="p">:</span> <span class="n">independent_newsletters</span><span class="p">,</span>
        <span class="s1">&#39;is_paginated&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="o">.</span><span class="n">has_other_pages</span><span class="p">(),</span>
        <span class="s1">&#39;page_obj&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the newsletters page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/newsletters.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="categories_view">
<a class="viewcode-back" href="../../views.html#News_app.views.categories_view">[docs]</a>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">categories_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the categories list view, including article counts per</span>
<span class="sd">    category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all categories</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c1"># For each category</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="c1"># Get the count of published and approved articles</span>
        <span class="n">article_count</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
            <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="c1"># Set the article_count attribute</span>
        <span class="n">category</span><span class="o">.</span><span class="n">article_count</span> <span class="o">=</span> <span class="n">article_count</span>

    <span class="c1"># Prepare context for template</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="n">categories</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the categories page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/categories.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="publishers_view">
<a class="viewcode-back" href="../../views.html#News_app.views.publishers_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publishers_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the publishers list view, with edit permissions for editors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is authenticated and is a superuser</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># If user is not authenticated or does not have a valid role</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">or</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;journalist&#39;</span><span class="p">,</span> <span class="s1">&#39;reader&#39;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="c1"># Redirect to login page</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span>
    <span class="c1"># Get all publishers</span>
    <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># Set can_edit to True if user is an editor</span>
    <span class="n">can_edit</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;editor&#39;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="n">publishers</span><span class="p">,</span>
        <span class="s1">&#39;can_edit&#39;</span><span class="p">:</span> <span class="n">can_edit</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the publishers page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/publishers.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="subscribe_publisher_view">
<a class="viewcode-back" href="../../views.html#News_app.views.subscribe_publisher_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@require_POST</span>
<span class="nd">@role_required</span><span class="p">(</span><span class="s1">&#39;reader&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subscribe_publisher_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subscribe the current reader to a publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the publisher object</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="c1"># Create the subscription if it does not exist</span>
    <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
    <span class="p">)</span>
    <span class="c1"># Show success message</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Subscribed to publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
    <span class="c1"># Redirect to subscriptions page</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="category_articles_view">
<a class="viewcode-back" href="../../views.html#News_app.views.category_articles_view">[docs]</a>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">category_articles_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">category_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the articles list view for a specific category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the category object</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">category_id</span><span class="p">)</span>
    <span class="c1"># Get all published and approved articles for this category</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>

    <span class="c1"># Use shared pagination helper</span>
    <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginate_queryset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">articles</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># Prepare context for template</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
        <span class="s1">&#39;is_paginated&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="o">.</span><span class="n">has_other_pages</span><span class="p">(),</span>
        <span class="s1">&#39;page_obj&#39;</span><span class="p">:</span> <span class="n">page_obj</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the category articles page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/category_articles.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<span class="c1"># --------------------------- API ViewSets ---------------------------</span>

<div class="viewcode-block" id="UserViewSet">
<a class="viewcode-back" href="../../views.html#News_app.views.UserViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API ViewSet for managing User objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Queryset for all User objects</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># Default serializer for User</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="c1"># Require authentication for all actions</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="UserViewSet.get_serializer_class">
<a class="viewcode-back" href="../../views.html#News_app.views.UserViewSet.get_serializer_class">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the appropriate serializer class based on the action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If action is create</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;create&#39;</span><span class="p">:</span>
            <span class="c1"># Use UserCreateSerializer for creating new users</span>
            <span class="k">return</span> <span class="n">UserCreateSerializer</span>
        <span class="c1"># Otherwise use the default UserSerializer</span>
        <span class="k">return</span> <span class="n">UserSerializer</span></div>


<div class="viewcode-block" id="UserViewSet.me">
<a class="viewcode-back" href="../../views.html#News_app.views.UserViewSet.me">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">me</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current user profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Serialize the current user</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="c1"># Return the serialized data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="UserViewSet.by_role">
<a class="viewcode-back" href="../../views.html#News_app.views.UserViewSet.by_role">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">by_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get users by role</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the role from query parameters</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span>
        <span class="c1"># If role is provided</span>
        <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
            <span class="c1"># Filter users by the given role</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Return the serialized data</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># If no role provided, return error</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Role parameter is required&#39;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CategoryViewSet">
<a class="viewcode-back" href="../../views.html#News_app.views.CategoryViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CategoryViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API ViewSet for managing Category objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Queryset for all Category objects</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># Serializer for Category</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>
    <span class="c1"># Require authentication for all actions</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span></div>



<div class="viewcode-block" id="PublisherViewSet">
<a class="viewcode-back" href="../../views.html#News_app.views.PublisherViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PublisherViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API ViewSet for managing Publisher objects, including adding editors</span>
<span class="sd">    and journalists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Queryset for all Publisher objects</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># Serializer for Publisher</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PublisherSerializer</span>
    <span class="c1"># Require authentication for all actions</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="PublisherViewSet.add_editor">
<a class="viewcode-back" href="../../views.html#News_app.views.PublisherViewSet.add_editor">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an editor to the publisher</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the publisher object for this request</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># Get the user ID from request data</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the user with the given ID and role &#39;editor&#39;</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span>
            <span class="c1"># Create a PublisherStaff entry for this user and publisher</span>
            <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span>
            <span class="p">)</span>
            <span class="c1"># If user is successfully added, return success message</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Editor added successfully&#39;</span><span class="p">})</span>
        <span class="c1"># If user not found</span>
        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># return error</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Editor not found&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="PublisherViewSet.add_journalist">
<a class="viewcode-back" href="../../views.html#News_app.views.PublisherViewSet.add_journalist">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_journalist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a journalist to the publisher</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the publisher object for this request</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># Get the user ID from request data</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the user with the given ID and role &#39;journalist&#39;</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span><span class="p">)</span>
            <span class="c1"># Create a PublisherStaff entry for this user and publisher</span>
            <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span>
            <span class="p">)</span>
            <span class="c1"># If user is successfully added, return success message</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Journalist added successfully&#39;</span><span class="p">})</span>
        <span class="c1"># If user not found</span>
        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># return error</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Journalist not found&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ArticleViewSet">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ArticleViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API ViewSet for managing Article objects, with custom actions for</span>
<span class="sd">    approval and publishing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Serializer for Article objects</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ArticleSerializer</span>
    <span class="c1"># Require authentication for all actions</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="ArticleViewSet.get_queryset">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get all articles</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># Filter articles based on user role</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="c1"># If user is is a reader</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;reader&#39;</span><span class="p">:</span>
            <span class="c1"># Can only see published and approved articles</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># If user is a journalist</span>
        <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;journalist&#39;</span><span class="p">:</span>
            <span class="c1"># Can see their own articles + published approved articles</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Select related fields for efficiency</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArticleViewSet.get_serializer_class">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet.get_serializer_class">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the appropriate serializer class based on the action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If action is create</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;create&#39;</span><span class="p">:</span>
            <span class="c1"># Use ArticleCreateSerializer</span>
            <span class="k">return</span> <span class="n">ArticleCreateSerializer</span>
        <span class="c1"># Otherwise use the default ArticleSerializer</span>
        <span class="k">return</span> <span class="n">ArticleSerializer</span></div>


<div class="viewcode-block" id="ArticleViewSet.approve">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet.approve">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span>
            <span class="n">permission_classes</span><span class="o">=</span><span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">approve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approve an article (Editor only)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If user cannot approve articles</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Only editors can approve articles&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>

        <span class="c1"># Get the article object</span>
        <span class="n">article</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># Use the approval serializer to set is_approved=True</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">ArticleApprovalSerializer</span><span class="p">(</span>
            <span class="n">article</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_approved&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># If serializer is valid</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Return success message</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Article approved successfully&#39;</span><span class="p">})</span>
        <span class="c1"># Otherwise, return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArticleViewSet.publish">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet.publish">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish an article</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the article object</span>
        <span class="n">article</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># Check permissions: only the author or editors can publish</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;journalist&#39;</span> <span class="ow">and</span>
             <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="ow">or</span>
           <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;reader&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Permission denied&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>

        <span class="c1"># Set article as published and update published_date</span>
        <span class="n">article</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
        <span class="n">article</span><span class="o">.</span><span class="n">published_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Return the updated article data</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="c1"># Return the serialized data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArticleViewSet.my_articles">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet.my_articles">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">my_articles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current user&#39;s articles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter articles authored by the current user</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">articles</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Return the serialized data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArticleViewSet.pending_approval">
<a class="viewcode-back" href="../../views.html#News_app.views.ArticleViewSet.pending_approval">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pending_approval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get articles pending approval (Editor only)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If user cannot manage content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_manage_content</span><span class="p">():</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Only editors can view pending articles&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>

        <span class="c1"># Get articles that are not approved</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_approved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">articles</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Return the serialized data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NewsletterViewSet">
<a class="viewcode-back" href="../../views.html#News_app.views.NewsletterViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NewsletterViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API ViewSet for managing Newsletter objects, with custom actions for</span>
<span class="sd">    approval and publishing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Serializer for Newsletter objects</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">NewsletterSerializer</span>
    <span class="c1"># Require authentication for all actions</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="NewsletterViewSet.get_queryset">
<a class="viewcode-back" href="../../views.html#News_app.views.NewsletterViewSet.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get all newsletters</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="c1"># Filter newsletters based on user role</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;reader&#39;</span><span class="p">:</span>
            <span class="c1"># Readers can only see published and approved newsletters</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;journalist&#39;</span><span class="p">:</span>
            <span class="c1"># Journalists can see their own newsletters + published approved</span>
            <span class="c1"># newsletters</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Select related fields for efficiency</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NewsletterViewSet.approve">
<a class="viewcode-back" href="../../views.html#News_app.views.NewsletterViewSet.approve">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">approve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approve a newsletter (Editor only)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If user cannot approve newsletters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Only editors can approve newsletters&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>

        <span class="c1"># Get the newsletter object</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="c1"># Use the approval serializer to set is_approved=True</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">NewsletterApprovalSerializer</span><span class="p">(</span>
            <span class="n">newsletter</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_approved&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># If serializer is valid</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Return success message</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Newsletter approved successfully&#39;</span><span class="p">})</span>
        <span class="c1"># If serializer is not valid, return errors</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>


<div class="viewcode-block" id="NewsletterViewSet.publish">
<a class="viewcode-back" href="../../views.html#News_app.views.NewsletterViewSet.publish">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish a newsletter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the newsletter object</span>
        <span class="n">newsletter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="c1"># If user cannot publish newsletters</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;journalist&#39;</span> <span class="ow">and</span>
             <span class="n">newsletter</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="ow">or</span>
           <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;reader&#39;</span><span class="p">)):</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Permission denied&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>

        <span class="c1"># Set newsletter as published and update published_date</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">is_published</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">published_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Return the updated newsletter data</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>
        <span class="c1"># Return the serialized data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="NewsletterViewSet.my_newsletters">
<a class="viewcode-back" href="../../views.html#News_app.views.NewsletterViewSet.my_newsletters">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">my_newsletters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current user&#39;s newsletters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter newsletters authored by the current user</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">newsletters</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Return the serialized data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CommentViewSet">
<a class="viewcode-back" href="../../views.html#News_app.views.CommentViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CommentViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API ViewSet for managing Comment objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Serializer for Comment objects</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CommentSerializer</span>
    <span class="c1"># Require authentication for all actions</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="CommentViewSet.get_queryset">
<a class="viewcode-back" href="../../views.html#News_app.views.CommentViewSet.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get all comments</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Optionally filter by article ID if provided in query params</span>
        <span class="n">article_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">)</span>
        <span class="c1"># If article_id is provided</span>
        <span class="k">if</span> <span class="n">article_id</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">article_id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
        <span class="c1"># Return queryset filtered by article ID</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CommentViewSet.perform_create">
<a class="viewcode-back" href="../../views.html#News_app.views.CommentViewSet.perform_create">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="c1"># Set the author to the current user when creating a comment</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div>


<div class="viewcode-block" id="CommentViewSet.perform_update">
<a class="viewcode-back" href="../../views.html#News_app.views.CommentViewSet.perform_update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">perform_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="c1"># If the user is not the author of the comment</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;You can only edit your own comments&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="CommentViewSet.perform_destroy">
<a class="viewcode-back" href="../../views.html#News_app.views.CommentViewSet.perform_destroy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">perform_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a comment instance.</span>

<span class="sd">        Only the author or an editor can delete a comment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the user is not the author or an editor</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;editor&#39;</span><span class="p">):</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Permission denied&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise, delete the comment instance</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>
</div>



<span class="c1"># --- API Registration View ---</span>
<div class="viewcode-block" id="RegisterAPIView">
<a class="viewcode-back" href="../../views.html#News_app.views.RegisterAPIView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RegisterAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint for registering a new user.</span>
<span class="sd">    Accepts JSON data: username, password, email, first_name, last_name, role.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allow any user to register</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">AllowAny</span><span class="p">]</span>

<div class="viewcode-block" id="RegisterAPIView.post">
<a class="viewcode-back" href="../../views.html#News_app.views.RegisterAPIView.post">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserCreateSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># If serializer is valid</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Return success response with user data</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User registered successfully.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">UserCreateSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
            <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="c1"># Otherwise, return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PasswordChangeAPIView">
<a class="viewcode-back" href="../../views.html#News_app.views.PasswordChangeAPIView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PasswordChangeAPIView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint for changing the user&#39;s password.</span>
<span class="sd">    Accepts JSON data: old_password, new_password.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Override the post method to handle password change</span>
<div class="viewcode-block" id="PasswordChangeAPIView.post">
<a class="viewcode-back" href="../../views.html#News_app.views.PasswordChangeAPIView.post">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Get the user from the request</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old_password&#39;</span><span class="p">)</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_password&#39;</span><span class="p">)</span>

        <span class="c1"># Check if the old password matches the user&#39;s current password</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">old_password</span><span class="p">):</span>
            <span class="c1"># If not, return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Old password is incorrect.&quot;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        <span class="c1"># If correct, validate the new password</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="c1"># If it fails</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Return error response with validation error message</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        <span class="c1"># If validation passes, set the new password</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Return success response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Password changed successfully.&quot;</span><span class="p">})</span></div>
</div>



<div class="viewcode-block" id="password_reset_api_view">
<a class="viewcode-back" href="../../views.html#News_app.views.password_reset_api_view">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">password_reset_api_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to request a password reset.</span>
<span class="sd">    Accepts JSON data: {&quot;email&quot;: &lt;user_email&gt;}</span>
<span class="sd">    Sends a password reset link to the user&#39;s email.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Request user&#39;s email</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="c1"># If email is not provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="c1"># Return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email is required.&quot;</span><span class="p">},</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
    <span class="c1"># If email is provided</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get the user by email</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
    <span class="c1"># If user with this email does not exist</span>
    <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c1"># Return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User with this email does not exist.&quot;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>
    <span class="c1"># Generate password reset token and uid</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">default_token_generator</span><span class="o">.</span><span class="n">make_token</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">urlsafe_base64_encode</span><span class="p">(</span><span class="n">force_bytes</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
    <span class="c1"># Build password reset link (assuming frontend at /reset-password/)</span>
    <span class="n">reset_link</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;https://your-frontend-domain/reset-password/&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">/&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Build the email content</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Password Reset Requested&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Hi </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">,</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;You requested a password reset. Click the link below to reset your &quot;</span>
        <span class="s2">&quot;password:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reset_link</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;If you did not request this, please ignore this email.&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Send the email using Django&#39;s send_mail function</span>
    <span class="n">send_mail</span><span class="p">(</span>
        <span class="n">subject</span><span class="p">,</span>
        <span class="n">message</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_FROM_EMAIL</span><span class="p">,</span>
        <span class="p">[</span><span class="n">email</span><span class="p">],</span>
        <span class="n">fail_silently</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="c1"># Return success response</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Password reset link sent to your email.&quot;</span><span class="p">})</span></div>



<div class="viewcode-block" id="api_subscribe">
<a class="viewcode-back" href="../../views.html#News_app.views.api_subscribe">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_subscribe</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to subscribe the current user to a publisher or journalist.</span>
<span class="sd">    Accepts JSON: {&quot;publisher&quot;: &lt;publisher_id&gt;} or</span>
<span class="sd">    {&quot;journalist&quot;: &lt;journalist_id&gt;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get publisher or journalist ID from request data</span>
    <span class="n">publisher_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">)</span>
    <span class="n">journalist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;journalist&#39;</span><span class="p">)</span>
    <span class="c1"># If publisher_id is provided</span>
    <span class="k">if</span> <span class="n">publisher_id</span><span class="p">:</span>
        <span class="c1"># Try to get the publisher object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
        <span class="c1"># If publisher with this ID does not exist</span>
        <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Publisher not found.&quot;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise, create the subscription</span>
        <span class="n">sub</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
        <span class="p">)</span>
        <span class="c1"># If subscription was created</span>
        <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
            <span class="c1"># Return success response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Subscribed to publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
        <span class="c1"># If subscription already exists</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return message indicating already subscribed</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Already subscribed to publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
    <span class="c1"># If journalist_id is provided</span>
    <span class="k">elif</span> <span class="n">journalist_id</span><span class="p">:</span>
        <span class="c1"># Try to get the journalist object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span>
            <span class="p">)</span>
        <span class="c1"># If journalist with this ID does not exist</span>
        <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Journalist not found.&quot;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise, create the subscription</span>
        <span class="n">sub</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
        <span class="p">)</span>
        <span class="c1"># If subscription was created</span>
        <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
            <span class="c1"># Return success response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Subscribed to journalist &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
        <span class="c1"># If subscription already exists</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return message indicating already subscribed</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Already subscribed to journalist &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
    <span class="c1"># If neither publisher_id nor journalist_id is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Publisher or Journalist ID is required.&quot;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="api_add_comment">
<a class="viewcode-back" href="../../views.html#News_app.views.api_add_comment">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_add_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to add a comment to an article.</span>

<span class="sd">    Accepts JSON: {&quot;content&quot;: &lt;comment_content&gt;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the article ID from the URL</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span>
    <span class="c1"># If content is not provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
        <span class="c1"># Return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Comment content is required.&quot;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>
    <span class="c1"># Try to get the article object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="c1"># If article with this ID does not exist</span>
    <span class="k">except</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c1"># Return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Article not found.&quot;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>
    <span class="c1"># Otherwise, create the comment</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">article</span><span class="o">=</span><span class="n">article</span><span class="p">,</span>
        <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="n">content</span>
    <span class="p">)</span>
    <span class="c1"># Return success response with comment ID</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Comment added to article </span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comment_id&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">id</span>
    <span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span></div>



<div class="viewcode-block" id="api_list_subscriptions">
<a class="viewcode-back" href="../../views.html#News_app.views.api_list_subscriptions">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_list_subscriptions</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to list all publishers and journalists the current user is</span>
<span class="sd">    subscribed to.</span>

<span class="sd">    Returns a list of publishers and journalists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get subscriptions for publishers</span>
    <span class="n">publisher_subs</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">publisher__isnull</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">)</span>
    <span class="c1"># Get subscriptions for journalists</span>
    <span class="n">journalist_subs</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">journalist__isnull</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;journalist&#39;</span><span class="p">)</span>
    <span class="c1"># Prepare the response data for publishers</span>
    <span class="n">publishers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">description</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">publisher_subs</span>
    <span class="p">]</span>
    <span class="c1"># Prepare the response data for journalists</span>
    <span class="n">journalists</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s1">&#39;full_name&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">(),</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">sub</span><span class="o">.</span><span class="n">journalist</span><span class="o">.</span><span class="n">email</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">journalist_subs</span>
    <span class="p">]</span>
    <span class="c1"># Return the response data list</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
        <span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="n">publishers</span><span class="p">,</span>
        <span class="s1">&#39;journalists&#39;</span><span class="p">:</span> <span class="n">journalists</span>
    <span class="p">})</span></div>



<span class="c1"># --------- Subscribable Users API ---------</span>
<div class="viewcode-block" id="api_subscribable_users">
<a class="viewcode-back" href="../../views.html#News_app.views.api_subscribable_users">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_subscribable_users</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to get all publishers and journalists available to</span>
<span class="sd">    subscribe to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        {</span>
<span class="sd">        &#39;publishers&#39;: [...],</span>
<span class="sd">        &#39;journalists&#39;: [...]</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all publishers and journalists</span>
    <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">journalists</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span><span class="p">)</span>
    <span class="c1"># Serialize the publishers data</span>
    <span class="n">publisher_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">pub</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">pub</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">pub</span><span class="o">.</span><span class="n">description</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">publishers</span>
    <span class="p">]</span>
    <span class="c1"># Serialize the journalists data</span>
    <span class="n">journalist_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s1">&#39;full_name&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">(),</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">journalists</span>
    <span class="p">]</span>
    <span class="c1"># Return the serialized data</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
        <span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="n">publisher_data</span><span class="p">,</span>
        <span class="s1">&#39;journalists&#39;</span><span class="p">:</span> <span class="n">journalist_data</span>
    <span class="p">})</span></div>



<div class="viewcode-block" id="api_unsubscribe">
<a class="viewcode-back" href="../../views.html#News_app.views.api_unsubscribe">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_unsubscribe</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to unsubscribe the current user from a publisher or</span>
<span class="sd">    journalist.</span>

<span class="sd">    Accepts JSON: {&quot;publisher&quot;: &lt;publisher_id&gt;} or</span>
<span class="sd">    {&quot;journalist&quot;: &lt;journalist_id&gt;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get publisher or journalist ID from request data</span>
    <span class="n">publisher_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">)</span>
    <span class="n">journalist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;journalist&#39;</span><span class="p">)</span>
    <span class="c1"># If publisher_id is provided</span>
    <span class="k">if</span> <span class="n">publisher_id</span><span class="p">:</span>
        <span class="c1"># Try to get the publisher object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
        <span class="c1"># If publisher with this ID does not exist</span>
        <span class="k">except</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Publisher not found.&quot;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise, delete the subscription</span>
        <span class="n">deleted</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span>
        <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c1"># If subscription was deleted</span>
        <span class="k">if</span> <span class="n">deleted</span><span class="p">:</span>
            <span class="c1"># Return success response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsubscribed from publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
        <span class="c1"># If subscription was not found</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return message indicating not subscribed</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;You were not subscribed to publisher </span><span class="si">{</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
    <span class="c1"># If journalist_id is provided</span>
    <span class="k">elif</span> <span class="n">journalist_id</span><span class="p">:</span>
        <span class="c1"># Try to get the journalist object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">journalist</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">journalist_id</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span>
            <span class="p">)</span>
        <span class="c1"># If journalist with this ID does not exist</span>
        <span class="k">except</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># Return error response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Journalist not found.&quot;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise, delete the subscription</span>
        <span class="n">deleted</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">subscriber</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">journalist</span><span class="o">=</span><span class="n">journalist</span>
        <span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c1"># If subscription was deleted</span>
        <span class="k">if</span> <span class="n">deleted</span><span class="p">:</span>
            <span class="c1"># Return success response</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsubscribed from journalist &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
        <span class="c1"># If subscription was not found</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return message indicating not subscribed</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;You were not subscribed to journalist &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">journalist</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">journalist</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">})</span>
    <span class="c1"># If neither publisher_id nor journalist_id is provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return error response</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Publisher or Journalist ID is required.&quot;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="api_subscribed_content">
<a class="viewcode-back" href="../../views.html#News_app.views.api_subscribed_content">[docs]</a>
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permission_classes</span><span class="p">([</span><span class="n">IsAuthenticated</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_subscribed_content</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint to list all newsletters and articles from authors and</span>
<span class="sd">    publishers that the current user is subscribed to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        {</span>
<span class="sd">        &#39;articles&#39;: [...],</span>
<span class="sd">        &#39;newsletters&#39;: [...]</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get publisher and journalist subscriptions</span>
    <span class="n">publishers</span> <span class="o">=</span> <span class="n">get_subscribed_publishers</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">journalists</span> <span class="o">=</span> <span class="n">get_subscribed_journalists</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Get articles from subscribed publishers and journalists</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">publisher__in</span><span class="o">=</span><span class="n">publishers</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">author__in</span><span class="o">=</span><span class="n">journalists</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span>
        <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Get newsletters from subscribed publishers and journalists</span>
    <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">publisher__in</span><span class="o">=</span><span class="n">publishers</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">author__in</span><span class="o">=</span><span class="n">journalists</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">is_published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_approved</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">)</span>

    <span class="c1"># Serialize articles and newsletters</span>
    <span class="n">article_data</span> <span class="o">=</span> <span class="n">ArticleSerializer</span><span class="p">(</span><span class="n">articles</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="n">newsletter_data</span> <span class="o">=</span> <span class="n">NewsletterSerializer</span><span class="p">(</span><span class="n">newsletters</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Return the serialized data</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
        <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">article_data</span><span class="p">,</span>
        <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletter_data</span>
    <span class="p">})</span></div>



<span class="c1"># --------- Profile &amp; Content Management Views ---------</span>


<div class="viewcode-block" id="profile_view">
<a class="viewcode-back" href="../../views.html#News_app.views.profile_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">profile_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the user profile page, including subscriptions and authored</span>
<span class="sd">    content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subscribed_publishers</span> <span class="o">=</span> <span class="n">get_subscribed_publishers</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">subscribed_journalists</span> <span class="o">=</span> <span class="n">get_subscribed_journalists</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newsletters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">display_role</span> <span class="o">=</span> <span class="n">get_display_role</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># If user is a journalist, get their articles and newsletters</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;journalist&#39;</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">newsletters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">pending_articles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pending_newsletters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># If user can manage content, filter pending articles/newsletters</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;can_manage_content&#39;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">can_manage_content</span>
    <span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">News_app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">PublisherStaff</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">staff_publisher_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Filter articles the editor can approve</span>
        <span class="n">articles_qs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">filtered_articles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles_qs</span><span class="p">:</span>
            <span class="c1"># If article is independent and user can approve articles</span>
            <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">is_independent</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
                <span class="c1"># Add to filtered_articles</span>
                <span class="n">filtered_articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="c1"># If article is for a publisher the user can approve</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">article</span><span class="o">.</span><span class="n">publisher_id</span>
                <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">()</span>
                <span class="ow">and</span> <span class="n">article</span><span class="o">.</span><span class="n">publisher_id</span> <span class="ow">in</span> <span class="n">staff_publisher_ids</span>
            <span class="p">):</span>
                <span class="c1"># Add to filtered_articles</span>
                <span class="n">filtered_articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="n">pending_articles</span> <span class="o">=</span> <span class="n">filtered_articles</span>
        <span class="c1"># Filter newsletters the editor can approve</span>
        <span class="n">newsletters_qs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">filtered_newsletters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newsletter</span> <span class="ow">in</span> <span class="n">newsletters_qs</span><span class="p">:</span>
            <span class="c1"># If newsletter is independent and user can approve articles</span>
            <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">is_independent</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
                <span class="c1"># Add to filtered_newsletters</span>
                <span class="n">filtered_newsletters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>
            <span class="c1"># If newsletter is for a publisher the user can approve</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher_id</span>
                <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">()</span>
                <span class="ow">and</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher_id</span> <span class="ow">in</span> <span class="n">staff_publisher_ids</span>
            <span class="p">):</span>
                <span class="c1"># Add to filtered_newsletters</span>
                <span class="n">filtered_newsletters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>
        <span class="n">pending_newsletters</span> <span class="o">=</span> <span class="n">filtered_newsletters</span>
    <span class="c1"># Render the profile page with all context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/profile.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;subscribed_publishers&#39;</span><span class="p">:</span> <span class="n">subscribed_publishers</span><span class="p">,</span>
            <span class="s1">&#39;subscribed_journalists&#39;</span><span class="p">:</span> <span class="n">subscribed_journalists</span><span class="p">,</span>
            <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
            <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
            <span class="s1">&#39;display_role&#39;</span><span class="p">:</span> <span class="n">display_role</span><span class="p">,</span>
            <span class="s1">&#39;pending_articles&#39;</span><span class="p">:</span> <span class="n">pending_articles</span><span class="p">,</span>
            <span class="s1">&#39;pending_newsletters&#39;</span><span class="p">:</span> <span class="n">pending_newsletters</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="newsletter_detail_view">
<a class="viewcode-back" href="../../views.html#News_app.views.newsletter_detail_view">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">newsletter_detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the detail view for a single newsletter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is authenticated and is a superuser</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Render the newsletter detail page with context</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/newsletter_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="edit_newsletter_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_newsletter_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_newsletter_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a journalist to edit their own newsletter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is a superuser</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get the newsletter object</span>
    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>
    <span class="c1"># If the user is not the author of the newsletter</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">author</span><span class="p">:</span>
        <span class="c1"># Deny access to editing newsletter</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;You do not have permission to edit this newsletter.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># If the request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Bind form with POST data and newsletter instance</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># Save the changes</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Redirect to my_newsletters</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;my_newsletters&#39;</span><span class="p">)</span>
    <span class="c1"># If the request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create a form with the newsletter instance</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">newsletter</span><span class="p">)</span>
    <span class="c1"># Render the edit newsletter page with form and newsletter</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/create_newsletter.html&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">newsletter</span><span class="p">,</span>
            <span class="s1">&#39;page_title&#39;</span><span class="p">:</span> <span class="s1">&#39;Edit Newsletter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;button_text&#39;</span><span class="p">:</span> <span class="s1">&#39;Save Changes&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="register_view">
<a class="viewcode-back" href="../../views.html#News_app.views.register_view">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the user registration page and handle registration logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the user is authenticated and an admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># If the request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Bind form with POST data</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserCreationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># Save the new user and log them in</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="c1"># Redirect to profile page after successful registration</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
    <span class="c1"># If the request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create a blank registration form</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserCreationForm</span><span class="p">()</span>
    <span class="c1"># Render the registration page with the form</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/register.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="my_articles_view">
<a class="viewcode-back" href="../../views.html#News_app.views.my_articles_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_articles_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the list of articles authored by the current user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the user is an admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get all articles authored by the current user</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
    <span class="c1"># Get independent articles authored by the current user</span>
    <span class="n">independent_articles</span> <span class="o">=</span> <span class="n">articles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_independent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Render the my articles page with articles and independent articles</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/my_articles.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">articles</span><span class="p">,</span>
            <span class="s1">&#39;independent_articles&#39;</span><span class="p">:</span> <span class="n">independent_articles</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="my_newsletters_view">
<a class="viewcode-back" href="../../views.html#News_app.views.my_newsletters_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_newsletters_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the list of newsletters authored by the current user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the user is an admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get all newsletters authored by the current user (not independent)</span>
    <span class="n">newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">is_independent</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
    <span class="c1"># Get independent newsletters authored by the current user</span>
    <span class="n">independent_newsletters</span> <span class="o">=</span> <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">is_independent</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
    <span class="c1"># Render the page with newsletters and independent newsletters</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/my_newsletters.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">newsletters</span><span class="p">,</span>
            <span class="s1">&#39;independent_newsletters&#39;</span><span class="p">:</span> <span class="n">independent_newsletters</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="pending_approvals_view">
<a class="viewcode-back" href="../../views.html#News_app.views.pending_approvals_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@editor_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pending_approvals_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the list of articles and newsletters pending approval (for</span>
<span class="sd">    editors).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the user is an admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get all unpublished articles</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Get all unpublished newsletters</span>
    <span class="n">newsletters</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Newsletter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_published</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_date&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Get publisher staff editor ids for current user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">staff_publisher_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Filter articles the editor can approve</span>
    <span class="n">filtered_articles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
        <span class="c1"># If article is independent and user can approve</span>
        <span class="k">if</span> <span class="n">article</span><span class="o">.</span><span class="n">is_independent</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
            <span class="n">filtered_articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="c1"># If article is for a publisher the user can approve</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">article</span><span class="o">.</span><span class="n">publisher_id</span>
            <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">article</span><span class="o">.</span><span class="n">publisher_id</span> <span class="ow">in</span> <span class="n">staff_publisher_ids</span>
        <span class="p">):</span>
            <span class="n">filtered_articles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

    <span class="c1"># Filter newsletters the editor can approve</span>
    <span class="n">filtered_newsletters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">newsletter</span> <span class="ow">in</span> <span class="n">newsletters</span><span class="p">:</span>
        <span class="c1"># If newsletter is independent and user can approve</span>
        <span class="k">if</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">is_independent</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">():</span>
            <span class="n">filtered_newsletters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>
        <span class="c1"># If newsletter is for a publisher the user can approve</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher_id</span>
            <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">can_approve_articles</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">newsletter</span><span class="o">.</span><span class="n">publisher_id</span> <span class="ow">in</span> <span class="n">staff_publisher_ids</span>
        <span class="p">):</span>
            <span class="n">filtered_newsletters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newsletter</span><span class="p">)</span>

    <span class="c1"># Render the page with filtered articles and newsletters</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/pending_approvals.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;articles&#39;</span><span class="p">:</span> <span class="n">filtered_articles</span><span class="p">,</span>
            <span class="s1">&#39;newsletters&#39;</span><span class="p">:</span> <span class="n">filtered_newsletters</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_article_view">
<a class="viewcode-back" href="../../views.html#News_app.views.create_article_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a journalist to create a new article.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># If user is not a journalist</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;journalist&#39;</span><span class="p">:</span>
        <span class="c1"># Deny access to non-journalists</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;Only journalists can create articles.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">article</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Article created successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to my_articles after successful creation</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;my_articles&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">()</span>
    <span class="c1"># Render the create article page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/create_article.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="edit_article_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_article_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_article_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a journalist to edit their own article.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="c1"># Only the journalist who created the article can edit</span>
    <span class="c1"># If user is not the author</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span><span class="p">:</span>
        <span class="c1"># Deny access to editing article</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;You do not have permission to edit this article.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">article</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Article updated successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to my_articles after successful update</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;my_articles&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ArticleForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">article</span><span class="p">)</span>
    <span class="c1"># Render the edit article page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/create_article.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">article</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_publisher_view">
<a class="viewcode-back" href="../../views.html#News_app.views.create_publisher_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_publisher_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to create a new publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access to creating publishers</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Only admins can create publishers.&quot;</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Publisher created successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to admin_publishers after successful creation</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_publishers&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherForm</span><span class="p">()</span>
    <span class="c1"># Render the create publisher page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/create_publisher.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="edit_publisher_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_publisher_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_publisher_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to edit an existing publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access to editing publishers</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Only admins can edit publishers.&quot;</span><span class="p">)</span>
    <span class="c1"># Get the publisher object</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Publisher updated successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to admin_publishers after successful update</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_publishers&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PublisherForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">publisher</span><span class="p">)</span>
    <span class="c1"># Render the edit publisher page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/edit_publisher.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_category_view">
<a class="viewcode-back" href="../../views.html#News_app.views.create_category_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@editor_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_category_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an editor to create a new category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is an Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CategoryForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Category created successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to categories after successful creation</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CategoryForm</span><span class="p">()</span>
    <span class="c1"># Render the create category page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/create_category.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="edit_category_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_category_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@editor_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_category_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">category_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an editor to edit an existing category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is an Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get the category object</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">category_id</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CategoryForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Category updated successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to categories after successful update</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CategoryForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
    <span class="c1"># Render the edit category page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/edit_category.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="edit_profile_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_profile_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_profile_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a user to edit their profile information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is an Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserChangeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Profile updated successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to profile after successful update</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserChangeForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Render the edit profile page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/edit_profile.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="create_newsletter_view">
<a class="viewcode-back" href="../../views.html#News_app.views.create_newsletter_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_newsletter_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a journalist to create a new newsletter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># If user is not a journalist</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;journalist&#39;</span><span class="p">:</span>
        <span class="c1"># Deny access to creating newsletters</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;Only journalists can create newsletters.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">newsletter</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">newsletter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Newsletter created successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to newsletters after successful creation</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;newsletters&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewsletterForm</span><span class="p">()</span>
    <span class="c1"># Render the create newsletter page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/create_newsletter.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>



<div class="viewcode-block" id="approve_article_view">
<a class="viewcode-back" href="../../views.html#News_app.views.approve_article_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@editor_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">approve_article_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an editor to approve an article.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Approve the article</span>
    <span class="k">return</span> <span class="n">approve_content</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">Article</span><span class="p">,</span> <span class="n">article_id</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="approve_newsletter_view">
<a class="viewcode-back" href="../../views.html#News_app.views.approve_newsletter_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@editor_required</span>
<span class="nd">@require_POST</span>
<span class="k">def</span><span class="w"> </span><span class="nf">approve_newsletter_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an editor to approve a newsletter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Approve the newsletter</span>
    <span class="k">return</span> <span class="n">approve_content</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">Newsletter</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">,</span> <span class="s1">&#39;newsletter&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete_article_view">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_article_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_article_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an author or editor to delete an article.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Delete the article</span>
    <span class="k">return</span> <span class="n">delete_content</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">Article</span><span class="p">,</span>
        <span class="n">article_id</span><span class="p">,</span>
        <span class="s1">&#39;article&#39;</span><span class="p">,</span>
        <span class="s1">&#39;my_articles&#39;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="delete_newsletter_view">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_newsletter_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_newsletter_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an author or editor to delete a newsletter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Delete the newsletter</span>
    <span class="k">return</span> <span class="n">delete_content</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">Newsletter</span><span class="p">,</span>
        <span class="n">newsletter_id</span><span class="p">,</span>
        <span class="s1">&#39;newsletter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;newsletters&#39;</span>
    <span class="p">)</span></div>



<span class="c1"># --------- Admin Publisher Management Views ---------</span>

<div class="viewcode-block" id="admin_publishers_view">
<a class="viewcode-back" href="../../views.html#News_app.views.admin_publishers_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_publishers_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the admin view for managing all publishers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access.</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># For each publisher, get editor and journalist staff</span>
    <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">:</span>
        <span class="n">publisher</span><span class="o">.</span><span class="n">editor_staff</span> <span class="o">=</span> <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;editor&#39;</span>
        <span class="p">)</span>
        <span class="n">publisher</span><span class="o">.</span><span class="n">journalist_staff</span> <span class="o">=</span> <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="s1">&#39;journalist&#39;</span>
        <span class="p">)</span>
    <span class="c1"># Render the admin publishers page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/admin_publishers.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;publishers&#39;</span><span class="p">:</span> <span class="n">publishers</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="add_publisher_staff_view">
<a class="viewcode-back" href="../../views.html#News_app.views.add_publisher_staff_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_publisher_staff_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to add staff (editor/journalist) to a publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CustomUser</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
        <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="n">role</span>
        <span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> added.&quot;</span><span class="p">)</span>
        <span class="c1"># Redirect to admin publishers after adding staff</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_publishers&#39;</span><span class="p">)</span>
    <span class="c1"># Get all users with the specified role</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
    <span class="n">existing_staff_ids</span> <span class="o">=</span> <span class="n">PublisherStaff</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">publisher</span><span class="o">=</span><span class="n">publisher</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">role</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Render the add publisher staff page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/add_publisher_staff.html&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
            <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">,</span>
            <span class="s1">&#39;existing_staff_ids&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">existing_staff_ids</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="edit_publisher_staff_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_publisher_staff_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_publisher_staff_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">staff_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to edit publisher staff assignments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">staff</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PublisherStaff</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">staff_id</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">CustomUser</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
        <span class="n">staff</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">staff</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="n">staff</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Staff updated.&quot;</span><span class="p">)</span>
        <span class="c1"># Redirect to admin publishers after updating staff</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_publishers&#39;</span><span class="p">)</span>
    <span class="c1"># Get all users with editor or journalist role</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">role__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;journalist&#39;</span><span class="p">])</span>
    <span class="c1"># Render the edit publisher staff page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/edit_publisher_staff.html&#39;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="n">staff</span><span class="p">,</span>
            <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="delete_publisher_staff_view">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_publisher_staff_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_publisher_staff_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">staff_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to delete a publisher staff assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">staff</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PublisherStaff</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">staff_id</span><span class="p">)</span>
    <span class="c1"># Delete staff assignment</span>
    <span class="n">staff</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Staff deleted.&quot;</span><span class="p">)</span>
    <span class="c1"># Redirect to admin publishers</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_publishers&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete_publisher_view">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_publisher_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_admin</span><span class="p">)</span>
<span class="nd">@require_POST</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_publisher_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">publisher_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to delete a publisher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the publisher object</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">publisher_id</span><span class="p">)</span>
    <span class="c1"># Delete publisher</span>
    <span class="n">publisher</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="c1"># Redirect to admin publishers</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_publishers&#39;</span><span class="p">)</span></div>



<span class="c1"># View publisher staff details (admin only)</span>
<div class="viewcode-block" id="view_publisher_staff_view">
<a class="viewcode-back" href="../../views.html#News_app.views.view_publisher_staff_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@require_GET</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_publisher_staff_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">staff_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the detail view for a publisher staff assignment (admin only).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">staff</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PublisherStaff</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">staff_id</span><span class="p">)</span>
    <span class="c1"># Render the staff detail page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/view_publisher_staff.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="n">staff</span><span class="p">}</span>
    <span class="p">)</span></div>



<span class="c1"># Admin: Manage Users view (basic, for navigation)</span>
<div class="viewcode-block" id="admin_users_view">
<a class="viewcode-back" href="../../views.html#News_app.views.admin_users_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">admin_users_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the admin view for managing all users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">CustomUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="c1"># Set display role for each user</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">user</span><span class="o">.</span><span class="n">display_role</span> <span class="o">=</span> <span class="n">get_display_role</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Render the admin users page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/admin_users.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">})</span></div>



<span class="c1"># --------- Admin User Management Views ---------</span>
<div class="viewcode-block" id="view_user">
<a class="viewcode-back" href="../../views.html#News_app.views.view_user">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">view_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the detail view for a user (admin only).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">(),</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="c1"># Set display role for user</span>
    <span class="n">user</span><span class="o">.</span><span class="n">display_role</span> <span class="o">=</span> <span class="n">get_display_role</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Render the user detail page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/view_user.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span></div>



<div class="viewcode-block" id="edit_user">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_user">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to edit a user&#39;s information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">(),</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserChangeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="c1"># If form is valid</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;User updated successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to admin_users after successful update</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_users&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CustomUserChangeForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Render the edit user page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/edit_user.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="delete_user">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_user">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an admin to delete a user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is not an Admin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Admins only.&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">(),</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;User deleted successfully!&#39;</span><span class="p">)</span>
        <span class="c1"># Redirect to admin_users after successful deletion</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_users&#39;</span><span class="p">)</span>
    <span class="c1"># If request method is not POST</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/delete_user.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span></div>



<span class="c1"># --------- Publish Newsletter View ---------</span>
<div class="viewcode-block" id="publish_newsletter_view">
<a class="viewcode-back" href="../../views.html#News_app.views.publish_newsletter_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_newsletter_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">newsletter_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an editor to publish a newsletter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get the newsletter object</span>
    <span class="n">newsletter</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Newsletter</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">newsletter_id</span><span class="p">)</span>
    <span class="c1"># Publish the newsletter</span>
    <span class="k">return</span> <span class="n">publish_content</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">newsletter</span><span class="p">,</span>
        <span class="s1">&#39;newsletter&#39;</span><span class="p">,</span>
        <span class="n">staff_check</span><span class="o">=</span><span class="n">staff_editor_check</span>
    <span class="p">)</span></div>



<span class="c1"># --------- Publish Article View ---------</span>
<div class="viewcode-block" id="publish_article_view">
<a class="viewcode-back" href="../../views.html#News_app.views.publish_article_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="k">def</span><span class="w"> </span><span class="nf">publish_article_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">article_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow an editor to publish an article.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If user is Admin</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="c1"># Redirect to admin home</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;admin_home&#39;</span><span class="p">)</span>
    <span class="c1"># Get the article object</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="c1"># Publish the article</span>
    <span class="k">return</span> <span class="n">publish_content</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">article</span><span class="p">,</span>
        <span class="s1">&#39;article&#39;</span><span class="p">,</span>
        <span class="n">staff_check</span><span class="o">=</span><span class="n">staff_editor_check</span>
    <span class="p">)</span></div>



<span class="c1"># --------- Edit Comment View ---------</span>
<div class="viewcode-block" id="edit_comment_view">
<a class="viewcode-back" href="../../views.html#News_app.views.edit_comment_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_comment_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">comment_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a user or editor to edit a comment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the comment object</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
    <span class="c1"># If user cannot manage the comment</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_manage_comment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;You do not have permission to edit this comment.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># If content is empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Comment content is required.&#39;</span><span class="p">)</span>
        <span class="c1"># If content is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
            <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Comment updated successfully!&#39;</span><span class="p">)</span>
            <span class="c1"># Redirect to article detail after successful update</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;article_detail&#39;</span><span class="p">,</span> <span class="n">article_id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="c1"># Render the edit comment page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;news_app/edit_comment.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">})</span></div>



<span class="c1"># --------- Delete Comment View ---------</span>
<div class="viewcode-block" id="delete_comment_view">
<a class="viewcode-back" href="../../views.html#News_app.views.delete_comment_view">[docs]</a>
<span class="nd">@login_required</span>
<span class="nd">@superuser_redirect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_comment_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">comment_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow a user or editor to delete a comment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the comment object</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Comment</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
    <span class="c1"># If user cannot manage the comment</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_manage_comment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="c1"># Deny access</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;You do not have permission to delete this comment.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># If request method is POST</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">article_id</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">article</span><span class="o">.</span><span class="n">id</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Comment deleted successfully!&#39;</span><span class="p">)</span>
        <span class="c1"># Redirect to article detail after successful deletion</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;article_detail&#39;</span><span class="p">,</span> <span class="n">article_id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="c1"># Render the delete comment page</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s1">&#39;news_app/delete_comment.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">}</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Andrew French.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>